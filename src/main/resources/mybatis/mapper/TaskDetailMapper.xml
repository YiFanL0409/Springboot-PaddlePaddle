<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--namespace：绑定一个对应的Dao/Mapper接口-->
<mapper namespace="com.example.mapper.TaskDetailMapper">

    <!--查看所有进度详情信息-->
    <select id="queryAllTaskDetail" resultType="com.example.pojo.TaskDetail">
        select *
        from task_detail
    </select>
    <!--根据ID查询一条进度详情-->
    <select id="queryTaskDetailById" resultType="com.example.pojo.TaskDetail">
        select *
        from task_detail
        where id = #{id}
    </select>

    <select id="countByTask" resultType="java.lang.Integer">
        select count(*) from task_detail
        <where>
            <if test="id != null">
                taskId = #{id} AND
            </if>
            <if test="type == 'listen'">
                businessId IN (select listenId from listen) AND
            </if>
            <if test="type == 'book'">
                businessId IN (select bookId from book) AND
            </if>
            <if test="type == 'word'">
                businessId IN (select wordId from word) AND
            </if>
            1 = 1
        </where>
    </select>

    <select id="countByTaskToday" resultType="java.lang.Integer">
        select count(*) from task_detail
        <where>
            <if test="id != null">
                taskId = #{id} AND
            </if>
            <if test="type == 'listen'">
                businessId IN (select listenId from listen) AND
            </if>
            <if test="type == 'book'">
                businessId IN (select bookId from book) AND
            </if>
            <if test="type == 'word'">
                businessId IN (select wordId from word) AND
            </if>
            to_days(createTime) = to_days(now())
        </where>
    </select>
    <select id="countDaysByTaskIdAndUserId" resultType="java.lang.Integer">
        select count(distinct DATE_FORMAT(createTime, '%Y-%m-%d'))
        from task_detail
        where userId = #{userId}
          and taskId = #{taskId}
    </select>
    <select id="getTodayStudyWord" resultType="com.example.pojo.Word">
        select  distinct wordId,
                        wordName,
                        audio,
                        example,
                        explanation,
                        grade
        from word
        where wordId IN (
            select distinct businessId
            from task_detail
            where userId = #{userId}
              and taskId = #{taskId}
              and to_days(createTime) = to_days(now())
        )
    </select>
    <select id="countByDays" resultType="java.lang.Integer">
        select count(distinct wordId)
        from word
        where wordId IN (
            select distinct businessId
            from task_detail
            where userId = #{userId}
              and taskId = #{taskId}
              and to_days(now()) - to_days(createTime) = #{days}
        )
    </select>

    <!--添加一条进度详情-->
    <insert id="addTaskDetail" parameterType="com.example.pojo.TaskDetail">
        insert into task_detail(businessId, taskId, userId, createTime)
        values (#{businessId}, #{taskId}, #{userId}, #{createTime});
    </insert>
    <!--删除一条进度详情-->
    <delete id="deleteTaskDetail" parameterType="Integer">
        delete
        from task_detail
        where id = #{id}
    </delete>
    <delete id="deleteTaskDetailByTaskIdAndBusinessId">
        delete
        from task_detail
        where businessId = #{businessId}
          AND taskId = #{taskId}
    </delete>
    <delete id="deleteTaskDetailByTaskId">
        delete
        from task_detail
        where taskId = #{taskId}
    </delete>
    <!--修改一条进度详情-->
    <update id="updateTaskDetail" parameterType="com.example.pojo.TaskDetail">
        update task_detail
        set businessId=#{businessId},
            taskId=#{taskId},
            userId=#{userId},
            createTime=#{createTime}
        where id = #{id}
    </update>


</mapper>